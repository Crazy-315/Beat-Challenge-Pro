<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beat Challenge Pro - 语音感应版</title>
    <style>
        :root {
            --primary: #00f2ea;
            --secondary: #ff0050;
            --bg: #121212;
        }

        body {
            margin: 0; background: var(--bg); color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden;
        }

        /* 顶部看板 */
        .dashboard {
            position: absolute; top: 20px; display: flex; gap: 30px;
            font-size: 1.2rem; font-weight: bold;
        }
        .score-box { color: var(--primary); }
        .record-box { color: #f1c40f; }

        /* 核心展示区 */
        .stage { text-align: center; transition: all 0.3s; }
        
        .img-container {
            width: 200px; height: 200px; background: #222;
            border-radius: 20px; margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center;
            border: 4px solid #333; overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        #wordImg { max-width: 80%; max-height: 80%; object-fit: contain; }

        #word {
            font-size: 80px; font-weight: 900; text-transform: uppercase;
            margin: 10px 0; text-shadow: 0 0 20px rgba(0,242,234,0.5);
        }

        /* 麦克风状态指示 */
        .mic-status {
            width: 12px; height: 12px; background: gray;
            border-radius: 50%; display: inline-block; margin-right: 8px;
        }
        .mic-active { background: #2ecc71; box-shadow: 0 0 10px #2ecc71; }

        /* 结算弹窗 */
        #resultModal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; color: #333; padding: 40px; border-radius: 20px;
            text-align: center; display: none; z-index: 100; box-shadow: 0 0 50px rgba(0,0,0,1);
        }

        /* 输入设置区 */
        .setup-panel {
            background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;
            display: flex; flex-direction: column; gap: 10px; width: 350px;
        }
        textarea { height: 100px; border-radius: 10px; padding: 10px; border: none; }
        button {
            padding: 15px; background: var(--primary); border: none;
            border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem;
        }
        button:hover { background: #00d1ca; }

        .correct-anim { animation: success-pop 0.3s ease; color: #f1c40f !important; }
        @keyframes success-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="score-box">得分: <span id="currentScore">0</span></div>
        <div>进度: <span id="progressIdx">0</span> / <span id="totalTotal">0</span></div>
        <div><span id="micDot" class="mic-status"></span>录音中</div>
    </div>

    <div id="gameContent" style="display:none;">
        <div class="stage">
            <div class="img-container">
                <img id="wordImg" src="" alt="">
            </div>
            <div id="word">READY?</div>
        </div>
    </div>

    <div class="setup-panel" id="setup">
        <h2 style="margin:0">Beat Challenge Pro</h2>
        <p style="font-size:0.8rem; color:#aaa;">输入单词（英文逗号隔开，每组换行）</p>
        <textarea id="wordGroups">cat, hat, bat, fat
red, bed, fed, wed
apple, banana, pear, peach</textarea>
        <button onclick="initGame()">授权麦克风并开始</button>
        <p style="font-size:0.7rem; color:#888;">* 建议使用 Chrome 浏览器，需连接互联网</p>
    </div>

    <div id="resultModal">
        <h1 style="color:var(--secondary)">挑战结束！</h1>
        <div style="font-size: 1.5rem; margin: 20px 0;">
            共出现: <span id="finalTotal">0</span> 个单词<br>
            你读对: <span id="finalCorrect">0</span> 个单词
        </div>
        <button onclick="location.reload()">重新开始</button>
    </div>

    <script>
        let audioCtx, groups = [], currentGroupIdx = 0, currentWordIdx = 0;
        let score = 0, totalShown = 0, bpm = 70, isRunning = false;
        let recognition;
        let heardCurrentWord = false;

        const wordDisplay = document.getElementById('word');
        const imgDisplay = document.getElementById('wordImg');
        const scoreDisplay = document.getElementById('currentScore');
        const micDot = document.getElementById('micDot');

        // 1. 初始化语音识别
        function setupSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("抱歉，您的浏览器不支持语音识别，请换用 Chrome。");
                return;
            }
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                const text = event.results[last][0].transcript.toLowerCase();
                const target = wordDisplay.innerText.toLowerCase();
                
                if (text.includes(target) && !heardCurrentWord) {
                    markCorrect();
                }
            };

            recognition.onstart = () => micDot.classList.add('mic-active');
            recognition.onend = () => isRunning && recognition.start(); // 保持开启
            recognition.start();
        }

        function markCorrect() {
            heardCurrentWord = true;
            score++;
            scoreDisplay.innerText = score;
            wordDisplay.classList.add('correct-anim');
        }

        // 2. 核心逻辑
        function initGame() {
            const input = document.getElementById('wordGroups').value;
            groups = input.split('\n').map(line => line.split(',').map(w => w.trim()).filter(w => w));
            document.getElementById('totalTotal').innerText = groups.flat().length;
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            setupSpeech();
            
            document.getElementById('setup').style.display = 'none';
            document.getElementById('gameContent').style.display = 'block';
            
            isRunning = true;
            runBeat();
        }

        async function runBeat() {
            if (currentGroupIdx >= groups.length) {
                endGame();
                return;
            }

            const currentGroup = groups[currentGroupIdx];
            const targetWord = currentGroup[currentWordIdx];
            
            // 更新UI
            heardCurrentWord = false;
            wordDisplay.innerText = targetWord;
            wordDisplay.classList.remove('correct-anim');
            totalShown++;
            document.getElementById('progressIdx').innerText = totalShown;

            // 更新图片 (使用 Icons8 免费图标库，对常见名词非常友好)
            imgDisplay.src = `https://img.icons8.com/fluency/200/${targetWord.toLowerCase()}.png`;
            imgDisplay.onerror = () => { imgDisplay.src = `https://img.icons8.com/fluency/200/question-mark.png`; };

            // 播放节拍音
            playTick(currentWordIdx === 0);

            // 节拍间隔逻辑
            let interval = (60 / bpm) * 1000;
            
            setTimeout(() => {
                currentWordIdx++;
                if (currentWordIdx >= currentGroup.length) {
                    currentWordIdx = 0;
                    currentGroupIdx++;
                    bpm += 8; // 每组提速
                }
                if (isRunning) runBeat();
            }, interval);
        }

        function playTick(isHigh) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(isHigh ? 880 : 440, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function endGame() {
            isRunning = false;
            recognition.stop();
            document.getElementById('resultModal').style.display = 'block';
            document.getElementById('finalTotal').innerText = totalShown;
            document.getElementById('finalCorrect').innerText = score;
        }
    </script>
</body>
</html>
