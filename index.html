<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤ æ™ºèƒ½å£è¯­æŒ‘æˆ˜ Â· æé€Ÿç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: linear-gradient(145deg, #0b1c26 0%, #1a2f3a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Roboto, sans-serif;
            padding: 16px;
            overflow: hidden;
        }

        /* åˆå§‹å¯åŠ¨é®ç½© */
        #startOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(11, 28, 38, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #ffde9e;
        }

        .start-big-btn {
            background: #dd6b4b;
            color: white;
            border: none;
            padding: 30px 60px;
            border-radius: 100px;
            font-size: 2.5rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            border-bottom: 8px solid #813e2b;
        }
        .start-big-btn:active { transform: translateY(5px); border-bottom-width: 2px; }

        .game-card {
            max-width: 900px;
            width: 100%;
            background: rgba(12, 27, 35, 0.95);
            border-radius: 60px;
            padding: 40px;
            box-shadow: 0 30px 40px rgba(0, 0, 0, 0.8);
            border: 1px solid #3d6175;
            position: relative;
        }

        h1 { text-align: center; color: #ffde9e; font-size: 2.5rem; margin-bottom: 20px; text-shadow: 0 4px 10px black; }

        .visual-card {
            background: #12303e;
            border-radius: 50px;
            padding: 40px;
            text-align: center;
            border: 4px solid #6a9bb5;
            transition: all 0.3s;
        }
        /* è¯»å¯¹æ—¶çš„é—ªçƒæ•ˆæœ */
        .visual-card.success-flash {
            border-color: #4faa6a;
            background: #1a3e2a;
            transform: scale(1.02);
        }

        .icon-area { font-size: 12rem; margin-bottom: 10px; }
        .word-area {
            font-size: 6rem;
            font-weight: 800;
            color: #fff1d2;
            text-transform: uppercase;
            letter-spacing: 5px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            background: #0c2c3a;
            padding: 20px 40px;
            border-radius: 100px;
        }

        .score-box { font-size: 2.5rem; color: #ffe39c; font-weight: bold; }
        
        /* å½•éŸ³æŒ‡ç¤ºç¯ */
        .mic-status {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4faa6a;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .pulse {
            width: 15px;
            height: 15px;
            background: #4faa6a;
            border-radius: 50%;
            box-shadow: 0 0 0 rgba(79, 170, 106, 0.4);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(79, 170, 106, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(79, 170, 106, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 170, 106, 0); }
        }

        .status-msg {
            text-align: center;
            font-size: 1.8rem;
            color: #bed9ed;
            min-height: 2.5rem;
            margin-top: 20px;
        }

        .controls { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        button.ctrl-btn {
            background: #315f75;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="startOverlay">
        <h1 style="margin-bottom: 40px;">æ™ºèƒ½å£è¯­è‡ªåŠ¨æŒ‘æˆ˜</h1>
        <button class="start-big-btn" id="fullStartBtn">
            <i class="fas fa-play"></i> å¼€å¯æŒ‘æˆ˜
        </button>
        <p style="margin-top: 20px; color: #6a9bb5;">ç‚¹å‡»åå°†è‡ªåŠ¨å¼€å¯éº¦å…‹é£ä¸èŠ‚å¥</p>
    </div>

    <div class="game-card">
        <div class="mic-status" id="micStatus">
            <div class="pulse"></div> éº¦å…‹é£å·²å°±ç»ª (æŒç»­ç›‘å¬)
        </div>

        <div class="visual-card" id="mainCard">
            <div class="icon-area" id="wordIcon">ğŸ±</div>
            <div class="word-area" id="currentWord">CAT</div>
        </div>

        <div class="stats-row">
            <div class="score-box">
                å¾—åˆ†: <span id="scoreDisplay">0</span>
            </div>
            <div style="color: #ffde9e; font-size: 1.5rem;">
                BPM: <input type="range" id="bpmSlider" min="40" max="180" value="80"> 
                <span id="bpmValue">80</span>
            </div>
        </div>

        <div class="status-msg" id="statusMessage">è¯·æœ—è¯»å•è¯...</div>

        <div class="controls">
            <button class="ctrl-btn" id="resetBtn">ğŸ”„ é‡ç½®è¿›åº¦</button>
            <select id="topicSelect" style="padding: 10px; border-radius: 10px; background: #12303e; color: white;">
                <option value="animals">ğŸ¾ åŠ¨ç‰©</option>
                <option value="food">ğŸ é£Ÿç‰©</option>
                <option value="actions">âš½ åŠ¨ä½œ</option>
            </select>
        </div>
    </div>

<script>
    const TOPIC_DATA = {
        animals: [{w:'cat', i:'ğŸ±'}, {w:'dog', i:'ğŸ¶'}, {w:'pig', i:'ğŸ·'}, {w:'cow', i:'ğŸ®'}, {w:'bee', i:'ğŸ'}, {w:'fox', i:'ğŸ¦Š'}],
        food: [{w:'apple', i:'ğŸ'}, {w:'cake', i:'ğŸ°'}, {w:'egg', i:'ğŸ¥š'}, {w:'milk', i:'ğŸ¥›'}, {w:'pizza', i:'ğŸ•'}],
        actions: [{w:'run', i:'ğŸƒ'}, {w:'jump', i:'ğŸ¦˜'}, {w:'dance', i:'ğŸ’ƒ'}, {w:'swim', i:'ğŸŠ'}]
    };

    let words = [], icons = [], currentIndex = 0, score = 0;
    let bpm = 80, beatTimer = null, isAutoPlaying = false;
    let recognition = null;
    let keepListening = false; // æ§åˆ¶æ˜¯å¦æŒç»­å¾ªç¯ç›‘å¬

    // DOM
    const currentWordEl = document.getElementById('currentWord');
    const wordIconEl = document.getElementById('wordIcon');
    const scoreEl = document.getElementById('scoreDisplay');
    const statusEl = document.getElementById('statusMessage');
    const mainCard = document.getElementById('mainCard');

    // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
    function initSpeech() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ã€‚è¯·ä½¿ç”¨ Chromeã€‚");
            return;
        }
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.continuous = false; // æˆ‘ä»¬é€šè¿‡onendæ‰‹åŠ¨å¾ªç¯ï¼Œè¿™æ ·æ›´ç¨³å®š

        recognition.onresult = (event) => {
            const result = event.results[0][0].transcript.toLowerCase().replace(/[.,!?;:]/g, '').trim();
            const target = words[currentIndex].toLowerCase();
            
            statusEl.innerHTML = `å¬åˆ°: "<b>${result}</b>"`;

            if (result === target || result.includes(target)) {
                handleSuccess();
            }
        };

        recognition.onend = () => {
            // æ ¸å¿ƒæ”¹è¿›ï¼šåªè¦è¿˜æ²¡ç»“æŸï¼Œå°±ç«‹å³é‡æ–°å¼€å§‹ç›‘å¬
            if (keepListening) recognition.start();
        };

        recognition.onerror = () => {
            // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­å°è¯•ç›‘å¬
            if (keepListening) setTimeout(() => recognition.start(), 100);
        };
    }

    function handleSuccess() {
        score++;
        scoreEl.textContent = score;
        statusEl.innerHTML = `<span style="color: #4faa6a;">âœ… å¤ªæ£’äº†ï¼</span>`;
        mainCard.classList.add('success-flash');
        
        // è¯»å¯¹äº†ï¼šé‡ç½®èŠ‚æ‹å®šæ—¶å™¨ï¼Œå¹¶åœ¨çŸ­æš‚å»¶è¿Ÿåè·³è½¬
        stopBeat();
        setTimeout(() => {
            mainCard.classList.remove('success-flash');
            nextWord();
            startBeat(); // é‡æ–°å¼€å§‹è®¡æ—¶èŠ‚æ‹
        }, 600);
    }

    function nextWord() {
        currentIndex = (currentIndex + 1) % words.length;
        updateDisplay();
    }

    function updateDisplay() {
        currentWordEl.textContent = words[currentIndex];
        wordIconEl.textContent = icons[currentIndex];
    }

    function startBeat() {
        if (beatTimer) clearInterval(beatTimer);
        beatTimer = setInterval(() => {
            nextWord();
            statusEl.textContent = "æ—¶é—´åˆ°ï¼Œä¸‹ä¸€ä¸ªï¼";
        }, (60000 / bpm) * 2); // è®¾ä¸º2æ‹ä¸€ä¸ªè¯ï¼Œç»™ç”¨æˆ·ç•™æœ—è¯»æ—¶é—´
    }

    function stopBeat() {
        clearInterval(beatTimer);
    }

    // æ•´ä¸ªæµç¨‹çš„å¯åŠ¨å¼€å…³
    document.getElementById('fullStartBtn').addEventListener('click', () => {
        document.getElementById('startOverlay').classList.add('hidden');
        
        // åŠ è½½è¯åº“
        const topic = document.getElementById('topicSelect').value;
        words = TOPIC_DATA[topic].map(item => item.w);
        icons = TOPIC_DATA[topic].map(item => item.i);
        
        // å¯åŠ¨é€»è¾‘
        initSpeech();
        keepListening = true;
        recognition.start();
        startBeat();
        updateDisplay();
    });

    document.getElementById('bpmSlider').addEventListener('input', (e) => {
        bpm = e.target.value;
        document.getElementById('bpmValue').textContent = bpm;
        startBeat();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        score = 0;
        scoreEl.textContent = "0";
        currentIndex = 0;
        updateDisplay();
        statusEl.textContent = "è¿›åº¦å·²é‡ç½®";
    });

</script>
</body>
</html>
