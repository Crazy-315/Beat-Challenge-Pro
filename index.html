<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤ æ™ºèƒ½å£è¯­æŒ‘æˆ˜ Â· ä¿®å¤ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: linear-gradient(145deg, #0b1c26 0%, #1a2f3a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Roboto, sans-serif;
            padding: 16px;
            overflow: hidden;
        }

        #startOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(11, 28, 38, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #ffde9e;
        }

        .start-big-btn {
            background: #dd6b4b;
            color: white;
            border: none;
            padding: 30px 60px;
            border-radius: 100px;
            font-size: 2.5rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            border-bottom: 8px solid #813e2b;
        }
        .start-big-btn:active { transform: translateY(5px); border-bottom-width: 2px; }

        .game-card {
            max-width: 900px;
            width: 100%;
            background: rgba(12, 27, 35, 0.95);
            border-radius: 60px;
            padding: 40px;
            box-shadow: 0 30px 40px rgba(0, 0, 0, 0.8);
            border: 1px solid #3d6175;
            position: relative;
        }

        h1 { text-align: center; color: #ffde9e; font-size: 2.5rem; margin-bottom: 20px; text-shadow: 0 4px 10px black; }

        .visual-card {
            background: #12303e;
            border-radius: 50px;
            padding: 40px;
            text-align: center;
            border: 4px solid #6a9bb5;
            transition: all 0.3s;
        }
        .visual-card.success-flash {
            border-color: #4faa6a;
            background: #1a3e2a;
            transform: scale(1.02);
        }

        .icon-area { font-size: 12rem; margin-bottom: 10px; }
        .word-area {
            font-size: 6rem;
            font-weight: 800;
            color: #fff1d2;
            text-transform: uppercase;
            letter-spacing: 5px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            background: #0c2c3a;
            padding: 20px 40px;
            border-radius: 100px;
        }

        .score-box { font-size: 2.5rem; color: #ffe39c; font-weight: bold; }
        
        .mic-status {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4faa6a;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .pulse {
            width: 15px;
            height: 15px;
            background: #4faa6a;
            border-radius: 50%;
            box-shadow: 0 0 0 rgba(79, 170, 106, 0.4);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(79, 170, 106, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(79, 170, 106, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 170, 106, 0); }
        }

        .status-msg {
            text-align: center;
            font-size: 1.8rem;
            color: #bed9ed;
            min-height: 2.5rem;
            margin-top: 20px;
        }

        .controls { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        button.ctrl-btn {
            background: #315f75;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }

        .hidden { display: none !important; }
        .error-note {
            color: #ff8a7a;
            background: #3a1e1e;
            border-radius: 20px;
            padding: 8px 16px;
            margin-top: 8px;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

    <div id="startOverlay">
        <h1 style="margin-bottom: 40px;">æ™ºèƒ½å£è¯­è‡ªåŠ¨æŒ‘æˆ˜</h1>
        <button class="start-big-btn" id="fullStartBtn">
            <i class="fas fa-play"></i> å¼€å¯æŒ‘æˆ˜
        </button>
        <p style="margin-top: 20px; color: #6a9bb5;">ç‚¹å‡»åå°†è‡ªåŠ¨å¼€å¯éº¦å…‹é£ä¸èŠ‚å¥<br>è¯·ç¡®ä¿ä½¿ç”¨ https æˆ– localhost å¹¶å…è®¸éº¦å…‹é£</p>
    </div>

    <div class="game-card">
        <div class="mic-status" id="micStatus">
            <div class="pulse"></div> éº¦å…‹é£å·²å°±ç»ª (æŒç»­ç›‘å¬)
        </div>

        <div class="visual-card" id="mainCard">
            <div class="icon-area" id="wordIcon">ğŸ±</div>
            <div class="word-area" id="currentWord">CAT</div>
        </div>

        <div class="stats-row">
            <div class="score-box">
                å¾—åˆ†: <span id="scoreDisplay">0</span>
            </div>
            <div style="color: #ffde9e; font-size: 1.5rem;">
                BPM: <input type="range" id="bpmSlider" min="40" max="180" value="80"> 
                <span id="bpmValue">80</span>
            </div>
        </div>

        <div class="status-msg" id="statusMessage">è¯·æœ—è¯»å•è¯...</div>
        <div id="extraError" class="error-note hidden"></div>

        <div class="controls">
            <button class="ctrl-btn" id="resetBtn">ğŸ”„ é‡ç½®è¿›åº¦</button>
            <select id="topicSelect" style="padding: 10px; border-radius: 10px; background: #12303e; color: white;">
                <option value="animals">ğŸ¾ åŠ¨ç‰©</option>
                <option value="food">ğŸ é£Ÿç‰©</option>
                <option value="actions">âš½ åŠ¨ä½œ</option>
            </select>
        </div>
    </div>

<script>
    (function() {
        // ---------- è¯åº“ ----------
        const TOPIC_DATA = {
            animals: [{w:'cat', i:'ğŸ±'}, {w:'dog', i:'ğŸ¶'}, {w:'pig', i:'ğŸ·'}, {w:'cow', i:'ğŸ®'}, {w:'bee', i:'ğŸ'}, {w:'fox', i:'ğŸ¦Š'}],
            food: [{w:'apple', i:'ğŸ'}, {w:'cake', i:'ğŸ°'}, {w:'egg', i:'ğŸ¥š'}, {w:'milk', i:'ğŸ¥›'}, {w:'pizza', i:'ğŸ•'}],
            actions: [{w:'run', i:'ğŸƒ'}, {w:'jump', i:'ğŸ¦˜'}, {w:'dance', i:'ğŸ’ƒ'}, {w:'swim', i:'ğŸŠ'}]
        };

        // ---------- çŠ¶æ€å˜é‡ ----------
        let words = [], icons = [], currentIndex = 0, score = 0;
        let bpm = 80, beatTimer = null;
        let recognition = null;
        let keepListening = false;          // æ˜¯å¦æŒç»­é‡å¯è¯†åˆ«
        let processingSuccess = false;      // é˜²æ­¢é‡å¤åŠ åˆ†
        let restartTimeout = null;           // ç”¨äºå»¶è¿Ÿé‡å¯

        // DOM å…ƒç´ 
        const currentWordEl = document.getElementById('currentWord');
        const wordIconEl = document.getElementById('wordIcon');
        const scoreEl = document.getElementById('scoreDisplay');
        const statusEl = document.getElementById('statusMessage');
        const mainCard = document.getElementById('mainCard');
        const extraError = document.getElementById('extraError');
        const topicSelect = document.getElementById('topicSelect');
        const bpmSlider = document.getElementById('bpmSlider');
        const bpmValue = document.getElementById('bpmValue');
        const resetBtn = document.getElementById('resetBtn');
        const fullStartBtn = document.getElementById('fullStartBtn');
        const startOverlay = document.getElementById('startOverlay');

        // ---------- è¾…åŠ©å‡½æ•° ----------
        function loadTopic(topic) {
            const data = TOPIC_DATA[topic] || TOPIC_DATA.animals;
            words = data.map(item => item.w);
            icons = data.map(item => item.i);
            currentIndex = 0;     // åˆ‡æ¢ä¸»é¢˜ä»å¤´å¼€å§‹
            updateDisplay();
        }

        function updateDisplay() {
            if (words.length > 0) {
                currentWordEl.textContent = words[currentIndex].toUpperCase();
                wordIconEl.textContent = icons[currentIndex];
            }
        }

        function stopBeat() {
            if (beatTimer) {
                clearInterval(beatTimer);
                beatTimer = null;
            }
        }

        function startBeat() {
            stopBeat();
            if (!words.length) return;
            const intervalMs = (60000 / bpm) * 2;  // ä¸¤ä¸ªèŠ‚æ‹æ¢ä¸€æ¬¡è¯
            beatTimer = setInterval(() => {
                // åªæœ‰ä¸åœ¨â€œæˆåŠŸåŠ¨ç”»å¤„ç†ä¸­â€æ‰è‡ªåŠ¨è·³è¯ï¼Œé¿å…å¹²æ‰°
                if (!processingSuccess) {
                    nextWord();
                    statusEl.textContent = "â© æ—¶é—´åˆ°ï¼Œä¸‹ä¸€ä¸ªï¼";
                }
            }, intervalMs);
        }

        function nextWord() {
            if (words.length) {
                currentIndex = (currentIndex + 1) % words.length;
                updateDisplay();
            }
        }

        // æˆåŠŸæœ—è¯»å¤„ç† (å¸¦é˜²é‡å¤é”)
        function handleSuccess() {
            if (processingSuccess) return;  // æ­£åœ¨å¤„ç†ä¸­ï¼Œå¿½ç•¥æ–°çš„è¯†åˆ«ç»“æœ
            processingSuccess = true;

            // åŠ åˆ†ã€æ›´æ–°UI
            score++;
            scoreEl.textContent = score;
            statusEl.innerHTML = `<span style="color: #4faa6a;">âœ… å¤ªæ£’äº†ï¼ +1</span>`;
            mainCard.classList.add('success-flash');

            // åœæ­¢èŠ‚æ‹å™¨ï¼Œé¿å…ä¸­é€”è·³è¯
            stopBeat();

            // å»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€ä¸ªå•è¯ï¼Œæ¢å¤èŠ‚æ‹ï¼Œè§£é”
            setTimeout(() => {
                mainCard.classList.remove('success-flash');
                nextWord();
                startBeat();          // é‡æ–°å¯åŠ¨èŠ‚æ‹
                processingSuccess = false;  // è§£é”
                statusEl.textContent = "ğŸ‘‚ ç»§ç»­æœ—è¯»...";
            }, 700); // ç¨å¾®å»¶é•¿ï¼Œçœ‹æ¸…åé¦ˆ
        }

        // ---------- è¯­éŸ³è¯†åˆ«åˆå§‹åŒ– ----------
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                extraError.classList.remove('hidden');
                extraError.innerText = 'âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ã€‚è¯·ä½¿ç”¨ Chrome / Edgeã€‚';
                return null;
            }

            const recog = new SpeechRecognition();
            recog.lang = 'en-US';
            recog.continuous = false;       // æ¯ä¸ªçŸ­è¯­åè‡ªåŠ¨ç»“æŸï¼Œæˆ‘ä»¬ç”¨ onend é‡å¯ï¼Œæ›´ç²¾å‡†
            recog.interimResults = false;    // åªéœ€è¦æœ€ç»ˆç»“æœ
            recog.maxAlternatives = 1;       // æé«˜å‡†ç¡®ç‡

            recog.onstart = () => {
                extraError.classList.add('hidden'); // éšè—é”™è¯¯
                statusEl.textContent = 'ğŸ¤ éº¦å…‹é£å·²å¼€å¯ï¼Œè¯·æœ—è¯»...';
            };

            recog.onresult = (event) => {
                if (processingSuccess) return; // é”ä½æ—¶å¿½ç•¥æ–°ç»“æœ
                if (!words.length) return;

                const rawResult = event.results[0][0].transcript;
                // æ¸…ç†æ ‡ç‚¹ã€å¤šä½™ç©ºæ ¼ã€è½¬å°å†™
                const result = rawResult.toLowerCase().replace(/[.,!?;:'"\-]/g, '').trim();
                const target = words[currentIndex].toLowerCase();  // å½“å‰å•è¯

                statusEl.innerHTML = `å¬åˆ°: "<b>${result}</b>"`;

                // å®½æ¾åŒ¹é…ï¼šå…¨ç­‰ æˆ– åŒ…å«ç›®æ ‡è¯ (é¿å…è¯´ "a cat" ä¸è¯†åˆ«)
                if (result === target || result.includes(target)) {
                    handleSuccess();
                } else {
                    // å¯æç¤ºé”™è¯¯ï¼Œä½†ä¸æ‰“æ–­æµç¨‹
                    statusEl.innerHTML = `ğŸ‘‚ å¬åˆ° "${result}"ï¼Œå†è¯•è¯• "${target}"`;
                }
            };

            recog.onerror = (err) => {
                console.warn('è¯†åˆ«é”™è¯¯:', err.error);
                // æ˜¾ç¤ºå…·ä½“é”™è¯¯ï¼Œä¾¿äºè°ƒè¯•
                extraError.classList.remove('hidden');
                extraError.innerText = `âš ï¸ éº¦å…‹é£é”™è¯¯: ${err.error} (è‹¥ä¸º not-allowedï¼Œè¯·å…è®¸æƒé™ååˆ·æ–°é‡è¯•)`;

                // é‡åˆ°è‡´å‘½é”™è¯¯ï¼ˆå¦‚ not-allowedï¼‰ä¸å†ç›²ç›®é‡å¯
                if (err.error === 'not-allowed') {
                    keepListening = false;
                    statusEl.textContent = 'âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»';
                    return;
                }
                // å…¶ä»–é”™è¯¯ï¼ˆå¦‚ç½‘ç»œï¼‰å¯ä»¥å°è¯•æ¢å¤
            };

            recog.onend = () => {
                // å¦‚æœè¿˜åœ¨ä¿æŒç›‘å¬çŠ¶æ€ï¼Œåˆ™é‡å¯è¯†åˆ«ï¼ˆå¸¦çŸ­å»¶è¿Ÿï¼Œé¿å…é«˜é¢‘å†²çªï¼‰
                if (keepListening) {
                    if (restartTimeout) clearTimeout(restartTimeout);
                    restartTimeout = setTimeout(() => {
                        if (keepListening) {
                            try {
                                recog.start();
                            } catch (e) {
                                console.warn('é‡å¯å¤±è´¥', e);
                            }
                        }
                    }, 200);
                }
            };

            return recog;
        }

        // ---------- å¯åŠ¨æ‰€æœ‰æŒ‘æˆ˜ ----------
        function startChallenge() {
            // éšè—é®ç½©
            startOverlay.classList.add('hidden');

            // åŠ è½½å½“å‰ä¸»é¢˜è¯åº“
            const topic = topicSelect.value;
            loadTopic(topic);

            // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
            if (!recognition) {
                recognition = initSpeech();
                if (!recognition) return;  // æµè§ˆå™¨ä¸æ”¯æŒ
            }

            // å¼€å¯æŒç»­ç›‘å¬æ ‡è®°
            keepListening = true;

            // ç¡®ä¿ä¹‹å‰æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„è¯†åˆ«ï¼Œç„¶åå¼€å§‹
            try {
                recognition.start();
            } catch (e) {
                // å¦‚æœå·²ç»å¼€å§‹ï¼Œåˆ™å¿½ç•¥
                console.log('start exception (å¯èƒ½å·²åœ¨è¿è¡Œ):', e);
            }

            // å¯åŠ¨èŠ‚æ‹
            startBeat();

            // æ›´æ–°çŠ¶æ€
            statusEl.textContent = 'ğŸ¤ å·²å¯åŠ¨ï¼Œè¯·æœ—è¯»å•è¯...';
        }

        // ---------- é‡ç½®è¿›åº¦ ----------
        function resetProgress() {
            score = 0;
            scoreEl.textContent = '0';
            currentIndex = 0;
            updateDisplay();
            statusEl.textContent = 'ğŸ”„ è¿›åº¦å·²é‡ç½®';
            // ä¸éœ€è¦é‡ç½®è¯†åˆ«ï¼Œç»§ç»­ç›‘å¬å³å¯
        }

        // ---------- åˆ‡æ¢ä¸»é¢˜ ----------
        function onTopicChange() {
            if (!words.length) return;  // è¿˜æœªå¯åŠ¨ï¼Œä»…é¢„åŠ è½½

            const newTopic = topicSelect.value;
            loadTopic(newTopic);
            // å¯é€‰é‡ç½®åˆ†æ•°ï¼ˆæ ¹æ®ä¹ æƒ¯ï¼Œä¸€èˆ¬åˆ‡æ¢ä¸»é¢˜åˆ†æ•°å½’é›¶æ›´åˆç†ï¼‰
            score = 0;
            scoreEl.textContent = '0';
            statusEl.textContent = `ğŸ“š ä¸»é¢˜å·²åˆ‡æ¢ï¼Œå¼€å§‹æœ—è¯»å§`;
            // èŠ‚å¥ç»§ç»­ï¼Œä¸éœ€è¦é‡å¯è¯†åˆ«
        }

        // ---------- äº‹ä»¶ç»‘å®š ----------
        fullStartBtn.addEventListener('click', startChallenge);

        bpmSlider.addEventListener('input', (e) => {
            bpm = parseInt(e.target.value, 10);
            bpmValue.textContent = bpm;
            if (keepListening) {  // åªæœ‰åœ¨æŒ‘æˆ˜è¿›è¡Œä¸­æ‰åŠ¨æ€è°ƒæ•´èŠ‚æ‹
                startBeat();
            }
        });

        resetBtn.addEventListener('click', resetProgress);

        topicSelect.addEventListener('change', onTopicChange);

        // å¯é€‰ï¼šé˜²æ­¢åœ¨æ¸¸æˆæœªå¼€å§‹æ—¶åˆ‡æ¢ä¸»é¢˜å¯¼è‡´é”™è¯¯ (ä½†æ— å¤§ç¢)
        // ä¹Ÿå¯ä»¥é¢„å…ˆåŠ è½½é»˜è®¤è¯åº“ä»¥ä¾¿ä¸»é¢˜åˆ‡æ¢é¢„è§ˆ
        (function preloadDefault() {
            // åªæ˜¯ä¸ºäº†æ˜¾ç¤ºé»˜è®¤åŠ¨ç‰©
            const defaultTopic = 'animals';
            words = TOPIC_DATA[defaultTopic].map(item => item.w);
            icons = TOPIC_DATA[defaultTopic].map(item => item.i);
            currentIndex = 0;
            updateDisplay();
        })();

        // æ¸…ç†èµ„æº (é¡µé¢å…³é—­æ—¶)
        window.addEventListener('beforeunload', () => {
            if (recognition && keepListening) {
                keepListening = false;
                try { recognition.stop(); } catch (e) {}
            }
            if (restartTimeout) clearTimeout(restartTimeout);
            stopBeat();
        });

        // é¢å¤–è¯´æ˜ï¼šå¦‚æœé•¿æ—¶é—´æ²¡è§¦å‘ï¼Œå¯èƒ½æ˜¯æƒé™æˆ–æµè§ˆå™¨é™åˆ¶ï¼Œå¼•å¯¼ç”¨æˆ·
        // å¢åŠ æ‰‹åŠ¨åˆ·æ–°æç¤º
    })();
</script>
</body>
</html>
