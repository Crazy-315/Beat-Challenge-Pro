<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ èŠ‚å¥å£è¯­ï¼šå®½å®¹è°ƒé€Ÿç‰ˆ</title>
    <style>
        :root { --accent: #00f2ff; --bg: #050a0e; --success: #4eff91; --fail: #ff4e4e; }
        body {
            background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0;
        }

        #gameCard {
            width: 95%; max-width: 850px; background: rgba(255,255,255,0.03);
            padding: 40px; border-radius: 40px; border: 1px solid rgba(0,242,255,0.2);
            text-align: center; position: relative;
        }

        /* å•è¯ç½‘æ ¼ */
        .grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;
            margin: 30px 0;
        }
        .box {
            background: #101a24; padding: 20px 10px; border-radius: 20px;
            border: 3px solid transparent; transition: 0.2s;
        }
        .box i { font-size: 3rem; display: block; margin-bottom: 8px; }
        .box span { font-weight: 800; text-transform: uppercase; font-size: 1.1rem; }

        /* çŠ¶æ€æ¡†æ ·å¼ */
        .box.active { 
            border-color: var(--accent); 
            box-shadow: 0 0 25px rgba(0,242,255,0.6);
            transform: scale(1.05);
        }
        .box.correct { border-color: var(--success); background: rgba(78,255,145,0.15); }
        .box.wrong { border-color: var(--fail); background: rgba(255,78,78,0.15); opacity: 0.6; }

        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .info-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1.2rem; }
        .round-tag { color: var(--accent); font-weight: bold; }

        /* é€Ÿåº¦è°ƒèŠ‚å™¨ */
        .speed-ctrl { margin: 20px 0; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; }
        input[type=range] { width: 200px; cursor: pointer; }

        /* å¯åŠ¨å±‚ */
        .start-overlay {
            position: absolute; inset: 0; background: rgba(5,10,14,0.95);
            z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 40px;
        }
        .btn {
            background: var(--accent); color: black; border: none; padding: 18px 50px;
            border-radius: 50px; font-size: 1.6rem; font-weight: 900; cursor: pointer;
            box-shadow: 0 8px 0 #008f96; transition: 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 4px 0 #008f96; }
    </style>
</head>
<body>

    <div id="gameCard">
        <div id="overlay" class="start-overlay">
            <h1 style="font-size: 2.5rem; margin-bottom: 10px; color: var(--accent);">BEAT SPEAK</h1>
            <p style="color: #6a9bb5; margin-bottom: 20px;">è·Ÿç€é¼“ç‚¹è¯»å•è¯ (å®½å®¹æ¨¡å¼å·²å¼€å¯)</p>
            
            <div class="speed-ctrl">
                <label>åˆå§‹é€Ÿåº¦ (BPM): <span id="bpmVal">60</span></label><br><br>
                <input type="range" id="bpmSlider" min="40" max="120" value="60">
                <p style="font-size: 0.8rem; color: #4faa6a; margin-top: 10px;">æç¤ºï¼š40-60 é€‚åˆç»ƒä¹ ï¼Œ80+ æœ‰æŒ‘æˆ˜æ€§</p>
            </div>

            <button class="btn" id="startBtn">å¼€å§‹æŒ‘æˆ˜</button>
        </div>

        <div class="info-bar">
            <div class="round-tag">ç¬¬ <span id="roundNum">1</span> / 3 è½®</div>
            <div id="bpmDisplay" style="color:var(--accent)">BPM: 60</div>
            <div>å¾—åˆ†: <span id="scoreDisplay">0</span> / 30</div>
        </div>

        <div class="grid" id="wordGrid">
            </div>

        <div id="status" style="height: 40px; color: #6a9bb5; font-weight: bold;">ç­‰å¾…å¼€å§‹...</div>

        <div id="report" class="start-overlay" style="display:none">
            <h1 style="color:var(--accent)">æŒ‘æˆ˜ç»“æŸ</h1>
            <div style="font-size: 3rem; margin: 20px 0;" id="finalScore">å‡†ç¡®ç‡: 0%</div>
            <button class="btn" onclick="location.reload()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

<script>
    const POOL = [
        {w:'cat', i:'ğŸ±'}, {w:'dog', i:'ğŸ¶'}, {w:'pig', i:'ğŸ·'}, {w:'cow', i:'ğŸ®'},
        {w:'duck', i:'ğŸ¦†'}, {w:'bee', i:'ğŸ'}, {w:'fish', i:'ğŸŸ'}, {w:'egg', i:'ğŸ¥š'},
        {w:'apple', i:'ğŸ'}, {w:'cake', i:'ğŸ°'}, {w:'milk', i:'ğŸ¥›'}, {w:'pen', i:'âœ’ï¸'},
        {w:'car', i:'ğŸš—'}, {w:'ball', i:'âš½'}, {w:'book', i:'ğŸ“–'}
    ];

    let currentRound = 1;
    let currentIdx = -1;
    let score = 0;
    let bpm = 60;
    let words = [];
    let isPlaying = false;
    let audioCtx, nextNoteTime, timerID;
    let recognition;
    let currentWordRecognized = false;

    // 1. ç®€æ˜“é¼“æœº
    function playDrum(time, type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);

        if (type === 'kick') { // æµ‘åšé¼“ç‚¹
            osc.frequency.setValueAtTime(120, time);
            osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.4);
            gain.gain.setValueAtTime(0.8, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.4);
        } else { // æ¸…è„†é¼“ç‚¹
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(180, time);
            gain.gain.setValueAtTime(0.2, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
        }
        osc.start(time); osc.stop(time + 0.4);
    }

    // 2. æ ¸å¿ƒèŠ‚å¥å¼•æ“
    function scheduler() {
        while (nextNoteTime < audioCtx.currentTime + 0.1) {
            scheduleNextStep(nextNoteTime);
            const secondsPerBeat = 60.0 / bpm;
            nextNoteTime += secondsPerBeat;
            currentIdx++;
        }
        timerID = setTimeout(scheduler, 25);
    }

    function scheduleNextStep(time) {
        playDrum(time, currentIdx % 2 === 0 ? 'kick' : 'snare');
        
        setTimeout(() => {
            if (currentIdx >= 10) {
                checkRoundEnd();
                return;
            }
            
            // åˆ¤å®šä¸Šä¸€ä¸ªå•è¯ï¼šå¦‚æœæ²¡è¯»å¯¹ï¼Œå˜çº¢
            if (currentIdx > 0) {
                const prevBox = document.getElementById(`box-${currentIdx-1}`);
                if (!currentWordRecognized && !prevBox.classList.contains('correct')) {
                    prevBox.classList.add('wrong');
                }
                prevBox.classList.remove('active');
            }

            // æ¿€æ´»å½“å‰å•è¯
            currentWordRecognized = false;
            const currentBox = document.getElementById(`box-${currentIdx}`);
            currentBox.classList.add('active');
            document.getElementById('status').textContent = `æ­£åœ¨æ£€æµ‹: ${words[currentIdx].w.toUpperCase()}`;
        }, 0);
    }

    // 3. è¶…çº§å®½å®¹çš„è¯­éŸ³è¯†åˆ«
    function initSpeech() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = (event) => {
            if (currentIdx < 0 || currentIdx >= 10 || currentWordRecognized) return;
            
            let result = "";
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                result += event.results[i][0].transcript.toLowerCase();
            }

            const target = words[currentIdx].w.toLowerCase();
            
            // --- å®½å®¹åˆ¤å®šæ ¸å¿ƒ ---
            // 1. åŒ…å«å…³é”®è¯ 2. ç›¸ä¼¼åº¦ > 0.4 (éå¸¸ä½) 3. ç»“æœæœ«å°¾åŒ¹é…
            if (result.includes(target) || getSimilarity(result, target) > 0.4) {
                currentWordRecognized = true;
                score++;
                document.getElementById('scoreDisplay').textContent = score;
                const box = document.getElementById(`box-${currentIdx}`);
                box.classList.remove('active');
                box.classList.add('correct');
                document.getElementById('status').innerHTML = `<span style="color:var(--success)">âˆš åŒ¹é…æˆåŠŸ!</span>`;
            }
        };
    }

    // 4. ç¼–è¾‘è·ç¦»ç®—æ³•
    function getSimilarity(s1, s2) {
        // å¦‚æœè¾“å…¥å¤ªçŸ­ä¸å¤„ç†
        if (s1.length < 2) return 0;
        // æ£€æŸ¥æœ€åå‡ ä¸ªè¯ï¼Œå¢åŠ å¯¹å¿«é€Ÿè¿ç»­è¯»çš„å®¹é”™
        const wordsArr = s1.split(' ');
        const lastWord = wordsArr[wordsArr.length - 1];
        
        const compare = (a, b) => {
            const matrix = Array.from({length: a.length+1}, (_,i)=>[i]);
            for(let j=0; j<=b.length; j++) matrix[0][j]=j;
            for(let i=1; i<=a.length; i++) {
                for(let j=1; j<=b.length; j++) {
                    const cost = a[i-1]===b[j-1]?0:1;
                    matrix[i][j]=Math.min(matrix[i-1][j]+1, matrix[i][j-1]+1, matrix[i-1][j-1]+cost);
                }
            }
            return 1 - matrix[a.length][b.length] / Math.max(a.length, b.length);
        };
        
        return Math.max(compare(s1, s2), compare(lastWord, s2));
    }

    // 5. æ¸¸æˆæ§åˆ¶
    function startRound() {
        currentIdx = -1;
        currentWordRecognized = false;
        const grid = document.getElementById('wordGrid');
        grid.innerHTML = '';
        words = [];
        for(let i=0; i<10; i++){
            const item = POOL[Math.floor(Math.random()*POOL.length)];
            words.push(item);
            grid.innerHTML += `<div class="box" id="box-${i}"><i>${item.i}</i><span>${item.w}</span></div>`;
        }
        document.getElementById('bpmDisplay').textContent = `BPM: ${bpm}`;
        document.getElementById('roundNum').textContent = currentRound;
        nextNoteTime = audioCtx.currentTime + 0.5;
        scheduler();
    }

    function checkRoundEnd() {
        clearTimeout(timerID);
        if (currentRound < 3) {
            currentRound++;
            bpm += 15; // æ¯ä¸€è½®åªå¢åŠ  15 BPMï¼Œæ›´å¹³ç¼“
            setTimeout(startRound, 2500); 
            document.getElementById('status').textContent = "ä¸€è½®ç»“æŸï¼Œä¼‘æ¯ä¸€ä¸‹ï¼Œå‡†å¤‡åŠ é€Ÿ...";
        } else {
            showFinalReport();
        }
    }

    function showFinalReport() {
        recognition.stop();
        document.getElementById('report').style.display = 'flex';
        document.getElementById('finalScore').textContent = `å‡†ç¡®ç‡: ${Math.round((score/30)*100)}%`;
    }

    // BPM æ»‘å—
    const slider = document.getElementById('bpmSlider');
    slider.oninput = function() {
        bpm = parseInt(this.value);
        document.getElementById('bpmVal').textContent = bpm;
    };

    document.getElementById('startBtn').addEventListener('click', function() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.getElementById('overlay').style.display = 'none';
        initSpeech();
        recognition.start();
        startRound();
    });
</script>
</body>
</html>
